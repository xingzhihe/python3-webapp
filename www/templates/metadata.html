{% extends '__base__.html' %}

{% block title %}元数据{% endblock %}

{% block beforehead %}

<script>
    function initVM(data) {
        $('#vm').show();
        var vm = new Vue({
            el: '#vm',
            data: {
                datasources: data.datasources,
                page: data.page
            },
            methods: {
                edit_datasource: function (ds) {
                    location.assign('/manage/datasources/' + ds.id);
                },
                delete_datasource: function (ds) {
                    var msg = ds.host + ':' + ds.port;
                    if (confirm('确认要删除数据源“' + msg + '”？删除后不可恢复！')) {
                        deleteJSON('/api/datasources/' + ds.id, function (err, r) {
                            if (err) {
                                return error(err);
                            }
                            refresh();
                        });
                    }
                },
                show_databases: function(ds){
                    getJSON('/api/datasources/'+ds.id+'/databases', function (err, results) {
                        if (err) {
                            return fatal(err);
                        }
                        //$('#loading').hide();
                        initDatabases(ds, results);
                    });
                }
            }
        });
    }

    var vm_databases = undefined;
    function initDatabases(ds, data) {
        if(vm_tables){
            vm_databases.$data = { databses: data.databses };
        } else {
            $('#vm_databases').show();
            vm_databases = new Vue({
                el: '#vm_databases',
                data: {
                    databses: data.databses
                },
                methods: {
                    edit_database: function (db) {
                        location.assign('/manage/datasources/' + ds.id + '/' + db.name);
                    },
                    delete_database: function (db) {
                        var msg = db.name + '@' + ds.host + ':' + ds.port;
                        if (confirm('确认要删除数据库“' + msg + '”？删除后不可恢复！')) {
                            deleteJSON('/api/datasources/' + ds.id + '/databases/' + db.name, function (err, r) {
                                if (err) {
                                    return error(err);
                                }
                                refresh();
                            });
                        }
                    },
                    show_tables: function(db){
                        getJSON('/api/datasources/'+ds.id+'/databases/'+db.name+'/tables', function (err, results) {
                            if (err) {
                                return fatal(err);
                            }
                            //$('#loading').hide();
                            initTables(ds, db, results);
                        });
                    }
                }
            });
        }
    }
    
    var vm_tables = undefined;
    function initTables(ds, db, data) {
        if(vm_tables){
            vm_tables.$data = { tables: data.tables };
        } else {
            $('#vm_tables').show();
            vm_tables = new Vue({
                el: '#vm_tables',
                data: {
                    tables: data.tables
                }
            });
        }
    }
    $(function() {
        getJSON('/api/datasources', {
            page: {{ page_index }}
        }, function (err, results) {
            if (err) {
                return fatal(err);
            }
            $('#loading').hide();
            initVM(results);
        });
    });
</script>

{% endblock %}

{% block content %}

    <div class="uk-width-1-1 uk-margin-bottom">
        <div class="uk-panel uk-panel-box">
            <ul class="uk-breadcrumb">
                <li><a href="/manage/comments">评论</a></li>
                <li><a href="/manage/blogs">日志</a></li>
                <li><a href="/manage/users">用户</a></li>
                <li><a href="/manage/datasources">数据源</a></li>
                <li class="uk-active"><span>元数据</span></li>
                <li><a href="/manage/captcha">验证码</a></li>
            </ul>
        </div>
    </div>

    <div id="error" class="uk-width-1-1">
    </div>

    <div id="loading" class="uk-width-1-1 uk-text-center">
        <span><i class="uk-icon-spinner uk-icon-medium uk-icon-spin"></i> 正在加载...</span>
    </div>

    <div id="vm" class="uk-width-1-1" style="display:none">
        <a href="/manage/datasources/create" class="uk-button uk-button-primary"><i class="uk-icon-plus"></i> 新数据源</a>
        
        <table class="uk-table uk-table-hover">
            <thead>
                <tr>
                    <th class="uk-width-1-10">db_type</th>
                    <th class="uk-width-1-10">host</th>
                    <th class="uk-width-1-10">database</th>
                    <th class="uk-width-1-10">port</th>
                    <th class="uk-width-1-10">user</th>
                    <th class="uk-width-1-10">password</th>
                    <th class="uk-width-1-10">options</th>
                    <th class="uk-width-2-10">create datetime</th>
                    <th class="uk-width-1-10">操作</th>
                </tr>
            </thead>
            <tbody>
                <tr v-repeat="ds: datasources" >
                    <td>
                        <span v-text="ds.db_type"></span>
                    </td>
                    <td>
                        <span v-text="ds.host"></span>
                    </td>
                    <td>
                        <span v-text="ds.database"></span>
                    </td>
                    <td>
                        <span v-text="ds.port"></span>
                    </td>
                    <td>
                        <span v-text="ds.user"></span>
                    </td>
                    <td>
                        <span v-text="ds.password"></span>
                    </td>
                    <td>
                        <span v-text="ds.options"></span>
                    </td>
                    <td>
                        <span v-text="ds.created_at.toDateTime()"></span>
                    </td>
                    <td>
                        <a href="#0" v-on="click: edit_datasource(ds)"><i class="uk-icon-edit"></i></a>
                        <a href="#0" v-on="click: delete_datasource(ds)"><i class="uk-icon-trash-o"></i></a>
                        <a href="#0" v-on="click: show_databases(ds)"><i class="uk-icon-link">查看库</i></a>
                    </td>
                </tr>
            </tbody>
        </table>
        <div v-component="pagination" v-with="page"></div>
    </div>

    <div id="vm_databases" class="uk-width-1-1" style="display:none">
        
        <table class="uk-table uk-table-hover">
            <thead>
                <tr>
                    <th class="uk-width-2-5">name</th>
                    <th class="uk-width-2-5">comment</th>
                    <th class="uk-width-1-5">操作</th>
                </tr>
            </thead>
            <tbody>
                <tr v-repeat="ds: databses" >
                    <td>
                        <span v-text="ds.name"></span>
                    </td>
                    <td>
                        <span v-text="ds.comment"></span>
                    </td>
                    <td>
                        <a href="#0" v-on="click: show_tables(ds)"><i class="uk-icon-link">查看表</i></a>
                    </td>
                </tr>
            </tbody>
        </table>
        <!-- <div v-component="pagination" v-with="page"></div> -->
    </div>

    <div id="vm_tables" class="uk-width-1-1" style="display:none">
        
        <table class="uk-table uk-table-hover">
            <thead>
                <tr>
                    <th class="uk-width-2-5">name</th>
                    <th class="uk-width-2-5">comment</th>
                    <th class="uk-width-1-5">操作</th>
                </tr>
            </thead>
            <tbody>
                <tr v-repeat="item: tables" >
                    <td>
                        <span v-text="item.name"></span>
                    </td>
                    <td>
                        <span v-text="item.comment"></span>
                    </td>
                    <td>
                        <a href="#0" v-on="click: show_tables(item)"><i class="uk-icon-link">查看列</i></a>
                    </td>
                </tr>
            </tbody>
        </table>
        <!-- <div v-component="pagination" v-with="page"></div> -->
    </div>
{% endblock %}